<!--breadcrumbs-->
<div class="container-fluid breadcrumbs">
  <div class="container">
    <ol class="breadcrumb breadcrumb1 animated wow slideInLeft" data-wow-delay=".5s">
      <li><a href="<%= root_path %>"><span class="glyphicon glyphicon-home" aria-hidden="true"></span>Home</a></li>
      <li class="active">Shipping</li>
    </ol>
  </div>
</div><br><br>
<!--breadcrumbs-->
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxt8jyVF7hpNm2gxCjRMvzFt69pgvVYmk">
</script>
<div class="col-md-8 col-md-offset-2" style="margin-bottom:3em;margin-top:4em">
  <h1 style="text-align:center;font-size:45px;font-weight:700">Shipping Details</h1><br><br>
  <%= form_tag("/carts/pay", method: "post") do %>
      <div class="form-group">
        <%= label_tag(:first_name, "First Name") %>
        <%= text_field_tag(:first_name, nil, :class => 'form-control') %>
      </div>
      <div class="form-group">
        <%= label_tag(:second_name, "Second Name") %>
        <%= text_field_tag(:second_name, nil, :class => 'form-control') %>
      </div>
      <div class="form-group">
        <%= label_tag(:email, "Email") %>
        <%= text_field_tag(:email, nil, :class => 'form-control') %>
      </div>
      <div class="form-group">
        <%= label_tag(:phone_number, "Phone") %>
        <%= text_field_tag(:phone_number, nil, :class => 'form-control') %>
      </div>
      <div class="form-group">
        <%= label_tag(:address, "Address") %>
        <%= text_field_tag(:address, nil, :class => 'form-control') %>
      </div>
      <div class="form-group">
        <%= label_tag(:coupon, "Coupon") %>
        <%= text_field_tag(:coupon, nil, :class => 'form-control', placeholder: 'Can Be Blank') %>
      </div>
      <p></p>

      <% if @store.delivery_status == true %>

          <div class="form-group">
            <label> Delivery Location</label>
            <input id="locate" type="textbox" value="" class='form-control' placeholder='Delivery Location'/>
            <span style="color:green;" class="price"></span>
          </div>
          <p></p>

      <% end %>

      <% if @store.delivery_status == false %>

          <div class="form-group">
            <label> Collection Point for Goods</label>
            <textarea disabled type="text" value="" class='form-control' placeholder='Collection Instructions'><%= @store.detailed_location %></textarea>
            <span style="color:green;" class="price">We shall send instructions for pickup and contact points after you make your order</span>
          </div>
          <p></p>

      <% end %>

      <input id="long" name="long" type="hidden" value="">
      <input id="lat" name="lat" type="hidden" value="">
      <div id="suggesstion-box"></div>
      <div id="map"></div>
      <!-- <%= debug @response %><br><br> -->
      <%= submit_tag("Process Payment", :class => 'btn btn-success col-sm-12 col-md-6 col-md-offset-3') %><br>

  <% end %>


</div>
<script>

    $(function () {
        $('#locate').on('keyup', function () {
            setTimeout(function () {
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 8,
                    center: {lat: -34.397, lng: 150.644}
                });
                var geocoder = new google.maps.Geocoder();

                geocodeAddress(geocoder, map);

            }, 1000);
        });
    });

    function geocodeAddress(geocoder, resultsMap) {

        var address = document.getElementById('locate').value;
        geocoder.geocode({'address': address, region: 'KE'}, function (results, status) {
            if (status === 'OK') {

                var string = "";
                console.log(results);
                results.forEach(function (entry) {
                    string = string + '<p onclick=\'selectlocation("' + String(entry['formatted_address']) + '");\'>' + String(entry['formatted_address']) + '</p>';


                });
                $('#suggesstion-box').show();
                $('#suggesstion-box').html(string);
                console.log(string);
            } else {
                $('#suggesstion-box').html("Not Found, Try different search words");
            }
        });
    }

    function selectlocation(val) {

        $("#locate").val(val);
        $("#suggesstion-box").hide();
        $.ajax({
            type: 'POST',
            url: 'https://maps.googleapis.com/maps/api/geocode/json?address=' + val + '&key=AIzaSyCxt8jyVF7hpNm2gxCjRMvzFt69pgvVYmk',
            success: function (result) {
                results = result['results'];
                console.log(result);

                var latitude = results[0]['geometry']['location']['lat'];
                var longitude = results[0]['geometry']['location']['lng'];

              /*$("#lat").val(latitude);
               $("#long").val(longitude);*/
                sendyit2(longitude, latitude);
            },

        });
    }

    function sendyit2(lng, lat) {

        var body = {
            "command": "request",
            "data": {
                "api_key": "dM6shK8FuWZ5gH3kXCTe",
                "api_username": "myduka",
                "from": {
                    "from_name": "Green House",
                    "from_lat": -1.300577,
                    "from_long": 36.78183,
                    "from_description": ""
                },
                "to": {
                    "to_name": "KICC",
                    "to_lat": lat,
                    "to_long": lng,
                    "to_description": ""
                },
                "recepient": {
                    "recepient_name": "Sendy User",
                    "recepient_phone": "0728561783",
                    "recepient_email": "support@sendy.co.ke"
                },
                "delivery_details": {
                    "pick_up_date": "2016-04-20 12:12:12",
                    "collect_payment": {
                        "status": false,
                        "pay_method": 0,
                        "amount": 10
                    },
                    "return": true,
                    "note": " Sample note",
                    "note_status": true,
                    "request_type": "delivery",
                    "order_type": "ondemand_delivery",
                    "ecommerce_order": "ecommerce_order_001",
                    "skew": 1,
                    "package_size": [
                        {
                            "weight": 20,
                            "height": 10,
                            "width": 200,
                            "length": 30,
                            "item_name": "laptop"
                        }
                    ]
                }
            }
        };

        $.ajax({
            url: 'https://apitest.sendyit.com/v1/',
            contentType: 'html',
            headers: {"Accept": "application/json"},
            type: 'GET',
            crossDomain: true,
            beforeSend: function (xhr) {
                xhr.withCredentials = true;
            },
            //url:'https://private-anon-1d2df86698-sendypublicapi.apiary-proxy.com/v1/#request',
            method: 'post',
            data: body,
            success: function (res) {
                console.log(res);
                data = res['data'];
                $('.price').html(' <p> Price: ' + data['amount'] + '</p> <p>Order Number: ' + data['order_no'] + '</p>');
            }
        });
    }


</script>
